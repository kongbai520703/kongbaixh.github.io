<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>离线随机点名系统</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="/manifest.json">
    <style>
        /* 保持原有所有样式不变 */
        :root {
            --primary-color: #79C6FB;
            --danger-color: #e74c3c;
            --success-color: #2ecc71;
            --warning-color: #79C6FB;
            --white: #fff;
            --light-gray: #f8f9fa;
            --dark-gray: #2c3e50;
        }

        /* 保持所有原有CSS规则 */
        /* ... 原有全部样式内容 ... */
        
        /* 新增离线提示样式 */
        .offline-alert {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            display: none;
            z-index: 999;
            animation: slideUp 0.5s ease;
        }

        @keyframes slideUp {
            from { bottom: -50px; }
            to { bottom: 20px; }
        }
    </style>
</head>
<body>
    <!-- 原有HTML结构 -->
    <div class="container">
        <h1>🎯 随机点名系统</h1>
        <div id="display">准备就绪</div>
        <div class="buttons">
            <button id="startBtn">▶开始随机</button>
            <button id="stopBtn">⏹停止选择</button>
            <button id="manageBtn">📝管理名单</button>
        </div>
    </div>

    <div class="dialog">
        <div class="dialog-content">
            <!-- 原有对话框内容 -->
        </div>
    </div>

    <!-- 新增离线提示 -->
    <div class="offline-alert" id="offlineAlert">当前处于离线模式</div>

    <script>
        // 原有数据初始化代码
        if (!localStorage.getItem('classmates')) {
            localStorage.setItem('classmates', JSON.stringify([
                "付鑫", "任一祥", "许子豪", "李硕", "崔小天", "任辉", "唐钧", "徐浩", "袁鸿宇", "鲍雨歌", "马嘉亮", "任广兴", "刘新源", "马嘉亮", "贯子旺", "任一鸣", "任昱霖", "魏瑞", "魏聪旭","潘惠云", "王佳怡", "马梦晨", "张涛", "老师", "朱欣毅", "宋宇航", "刘俊阳"
            ]));
        }

        // 原有变量声明
        const students = JSON.parse(localStorage.getItem('classmates'));
        // ... 其他变量声明 ...

        // 新增离线状态检测
        function updateOnlineStatus() {
            const alert = document.getElementById('offlineAlert');
            if (!navigator.onLine) {
                alert.style.display = 'block';
            } else {
                alert.style.display = 'none';
            }
        }
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        updateOnlineStatus();

        // 原有功能函数（保持之前修复后的版本）
        function init() { /* ... */ }
        function bindEvents() { /* ... */ }
        function closeDialog() { /* ... */ }
        function refreshList() { /* ... */ }
        function updateCount() { /* ... */ }
        function addStudent() { /* ... */ }
        function batchAdd() { /* ... */ }
        function deleteStudent(index) { /* ... */ }
        function startRolling() { /* ... */ }
        function stopRolling() { /* ... */ }

        // ======= 新增PWA相关代码 =======
        // Service Worker注册
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('ServiceWorker注册成功:', registration.scope);
                        // 自动检查更新
                        registration.update();
                    })
                    .catch(err => {
                        console.log('ServiceWorker注册失败:', err);
                    });
            });
        }

        // 数据持久化
        let db;
        function initDB() {
            const request = indexedDB.open('RollcallDB', 1);
            
            request.onupgradeneeded = (event) => {
                db = event.target.result;
                if (!db.objectStoreNames.contains('backup')) {
                    db.createObjectStore('backup', { keyPath: 'id' });
                }
            };

            request.onsuccess = () => {
                db = request.result;
                // 恢复备份数据
                const transaction = db.transaction(['backup'], 'readonly');
                const store = transaction.objectStore('backup');
                store.get(1).onsuccess = (e) => {
                    const data = e.target.result;
                    if (data) {
                        localStorage.setItem('classmates', data.classmates);
                        localStorage.setItem('lastResult', data.lastResult);
                        students = JSON.parse(data.classmates);
                        refreshList();
                    }
                };
                // 启动定时备份
                setInterval(backupData, 300000);
            };
        }

        function backupData() {
            if (!db) return;
            
            const data = {
                id: 1,
                classmates: localStorage.getItem('classmates'),
                lastResult: localStorage.getItem('lastResult')
            };

            const transaction = db.transaction(['backup'], 'readwrite');
            const store = transaction.objectStore('backup');
            store.put(data);
        }

        // 初始化
        init();
        initDB();
    </script>
</body>
</html>
