<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ç¦»çº¿éšæœºç‚¹åç³»ç»Ÿ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="/manifest.json">
    <style>
        /* ä¿æŒåŸæœ‰æ‰€æœ‰æ ·å¼ä¸å˜ */
        :root {
            --primary-color: #79C6FB;
            --danger-color: #e74c3c;
            --success-color: #2ecc71;
            --warning-color: #79C6FB;
            --white: #fff;
            --light-gray: #f8f9fa;
            --dark-gray: #2c3e50;
        }

        /* ä¿æŒæ‰€æœ‰åŸæœ‰CSSè§„åˆ™ */
        /* ... åŸæœ‰å…¨éƒ¨æ ·å¼å†…å®¹ ... */
        
        /* æ–°å¢ç¦»çº¿æç¤ºæ ·å¼ */
        .offline-alert {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            display: none;
            z-index: 999;
            animation: slideUp 0.5s ease;
        }

        @keyframes slideUp {
            from { bottom: -50px; }
            to { bottom: 20px; }
        }
    </style>
</head>
<body>
    <!-- åŸæœ‰HTMLç»“æ„ -->
    <div class="container">
        <h1>ğŸ¯ éšæœºç‚¹åç³»ç»Ÿ</h1>
        <div id="display">å‡†å¤‡å°±ç»ª</div>
        <div class="buttons">
            <button id="startBtn">â–¶å¼€å§‹éšæœº</button>
            <button id="stopBtn">â¹åœæ­¢é€‰æ‹©</button>
            <button id="manageBtn">ğŸ“ç®¡ç†åå•</button>
        </div>
    </div>

    <div class="dialog">
        <div class="dialog-content">
            <!-- åŸæœ‰å¯¹è¯æ¡†å†…å®¹ -->
        </div>
    </div>

    <!-- æ–°å¢ç¦»çº¿æç¤º -->
    <div class="offline-alert" id="offlineAlert">å½“å‰å¤„äºç¦»çº¿æ¨¡å¼</div>

    <script>
        // åŸæœ‰æ•°æ®åˆå§‹åŒ–ä»£ç 
        if (!localStorage.getItem('classmates')) {
            localStorage.setItem('classmates', JSON.stringify([
                "ä»˜é‘«", "ä»»ä¸€ç¥¥", "è®¸å­è±ª", "æç¡•", "å´”å°å¤©", "ä»»è¾‰", "å”é’§", "å¾æµ©", "è¢é¸¿å®‡", "é²é›¨æ­Œ", "é©¬å˜‰äº®", "ä»»å¹¿å…´", "åˆ˜æ–°æº", "é©¬å˜‰äº®", "è´¯å­æ—º", "ä»»ä¸€é¸£", "ä»»æ˜±éœ–", "é­ç‘", "é­èªæ—­","æ½˜æƒ äº‘", "ç‹ä½³æ€¡", "é©¬æ¢¦æ™¨", "å¼ æ¶›", "è€å¸ˆ", "æœ±æ¬£æ¯…", "å®‹å®‡èˆª", "åˆ˜ä¿Šé˜³"
            ]));
        }

        // åŸæœ‰å˜é‡å£°æ˜
        const students = JSON.parse(localStorage.getItem('classmates'));
        // ... å…¶ä»–å˜é‡å£°æ˜ ...

        // æ–°å¢ç¦»çº¿çŠ¶æ€æ£€æµ‹
        function updateOnlineStatus() {
            const alert = document.getElementById('offlineAlert');
            if (!navigator.onLine) {
                alert.style.display = 'block';
            } else {
                alert.style.display = 'none';
            }
        }
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        updateOnlineStatus();

        // åŸæœ‰åŠŸèƒ½å‡½æ•°ï¼ˆä¿æŒä¹‹å‰ä¿®å¤åçš„ç‰ˆæœ¬ï¼‰
        function init() { /* ... */ }
        function bindEvents() { /* ... */ }
        function closeDialog() { /* ... */ }
        function refreshList() { /* ... */ }
        function updateCount() { /* ... */ }
        function addStudent() { /* ... */ }
        function batchAdd() { /* ... */ }
        function deleteStudent(index) { /* ... */ }
        function startRolling() { /* ... */ }
        function stopRolling() { /* ... */ }

        // ======= æ–°å¢PWAç›¸å…³ä»£ç  =======
        // Service Workeræ³¨å†Œ
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('ServiceWorkeræ³¨å†ŒæˆåŠŸ:', registration.scope);
                        // è‡ªåŠ¨æ£€æŸ¥æ›´æ–°
                        registration.update();
                    })
                    .catch(err => {
                        console.log('ServiceWorkeræ³¨å†Œå¤±è´¥:', err);
                    });
            });
        }

        // æ•°æ®æŒä¹…åŒ–
        let db;
        function initDB() {
            const request = indexedDB.open('RollcallDB', 1);
            
            request.onupgradeneeded = (event) => {
                db = event.target.result;
                if (!db.objectStoreNames.contains('backup')) {
                    db.createObjectStore('backup', { keyPath: 'id' });
                }
            };

            request.onsuccess = () => {
                db = request.result;
                // æ¢å¤å¤‡ä»½æ•°æ®
                const transaction = db.transaction(['backup'], 'readonly');
                const store = transaction.objectStore('backup');
                store.get(1).onsuccess = (e) => {
                    const data = e.target.result;
                    if (data) {
                        localStorage.setItem('classmates', data.classmates);
                        localStorage.setItem('lastResult', data.lastResult);
                        students = JSON.parse(data.classmates);
                        refreshList();
                    }
                };
                // å¯åŠ¨å®šæ—¶å¤‡ä»½
                setInterval(backupData, 300000);
            };
        }

        function backupData() {
            if (!db) return;
            
            const data = {
                id: 1,
                classmates: localStorage.getItem('classmates'),
                lastResult: localStorage.getItem('lastResult')
            };

            const transaction = db.transaction(['backup'], 'readwrite');
            const store = transaction.objectStore('backup');
            store.put(data);
        }

        // åˆå§‹åŒ–
        init();
        initDB();
    </script>
</body>
</html>
